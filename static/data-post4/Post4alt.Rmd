---
title: "Post 4"
output: html_notebook
---


We start loading the libraries.
```{r libraries, message=FALSE}
library(svDialogs)
library(tidyverse)
library(purrr)
library(foreign) 
library(RSQLite)
library(caret)
library(glmnet)
library(randomForest)
library(GGally)
library(broom)
library(rpart)



```

ADD Health
Where are the data:
[link1](https://www.icpsr.umich.edu/icpsrweb/content/DSDR/add-health-data-guide.html)
[link2](https://www.cpc.unc.edu/projects/addhealth/documentation/ace/tool/topics)


```{r selected_var, eval=TRUE, include=FALSE, message=FALSE}
var_select <- scan("/Users/heverz/Documents/R_projects/muaydata/static/data-post4/variables.csv", what  = "list", sep = ",")
```
```{r show_selected, eval=TRUE, include=TRUE}
var_select
```


```{r getdata, eval=FALSE}
files <- list.files(path = "/Users/heverz/Documents/R_projects/DATASETS/W1-4",
                    include.dirs=FALSE,
                    full.names = TRUE)

w1_4 <- map(files, read.dta)

# get the varibles in var_select
w1_4_reduced <- map(w1_4, function (x) x[, colnames(x) %in% var_select])

#join not empty dataframes
toselect <- which(map(w1_4_reduced, function(x) ncol(x) > 0) == TRUE)
heal_data <- plyr::join_all(w1_4_reduced[toselect] , by = "AID", type = "inner")
heal_data$AID <- as.character(heal_data$AID)
```

```{r database, include=FALSE, eval=TRUE}
mydb <- dbConnect(RSQLite::SQLite(), "/Users/heverz/Documents/R_projects/muaydata/static/data-post4/heal_data.sqlite")

# dbWriteTable(mydb, "heal_data", heal_data)
# dbListTables(mydb)
heal_data <- as_tibble(tbl(mydb, "heal_data"))
glimpse(heal_data)
```


```{r factor}
heal_sub <- heal_data[,2:length(heal_data)]
heal_sub <- mutate_if(heal_sub, is.character, as.factor)
sum(is.na(heal_sub))
```

There are a lot of NA because the questionare was not submitted to a some parents
```{r count_NAs}

heal_sub[is.na(heal_sub$PA10),] %>% 
  select(PA34:PC49E_3) %>% 
  glimpse()
```

WE will remove those data

```{r removeNAs}
heal_sub_cl <- 
  heal_sub %>% 
  select(-c("S10")) %>% 
  select(1:48,51) %>% 
  na.omit()

names(heal_sub_cl)
#classifier_NA_insert
heal_sub_cl <- 
  heal_sub_cl %>% 
  mutate(H4TO117 = as.factor(str_extract(heal_sub_cl$H4TO117 , "[:alpha:]+")))

heal_sub_cl3 <- heal_sub_cl
```

# 2 Classes

Classifier of interest is H4T0117

```{r 2Classes}
heal_sub_cl$H4TO117[heal_sub_cl$H4TO117 == "Legitimate"] <- "No"

heal_sub_cl$H4TO117 <- droplevels(heal_sub_cl$H4TO117)

summary(heal_sub_cl$H4TO117)
```


The problem is that we have a very unballanced designed and therefore all the models tend to maximaze accuracy but not specificity (they say all not addicted). So we need to consider specificity as a metric too



# Models: 2 classes

## Resample
```{r resample}

set.seed(1512)
up_heal <- upSample(x = heal_sub_cl[, -ncol(heal_sub_cl)],
                     y = heal_sub_cl$H4TO117)                         
table(up_heal$Class) 
```


## TrainControl

Explain adaptative cross validation and the other info
```{r trainControl}
fitControl <- trainControl(method = "adaptive_cv",
                           number = 5, repeats = 5,
                           classProbs = TRUE,
                           summaryFunction = twoClassSummary,
                           savePredictions = "final",
                            adaptive = list(min = 2,
                                            alpha = 0.05,
                                            method = "gls",
                                            complete = TRUE),
                           verboseIter = TRUE)
                           

```

## GLMNET MODEL


```{r load_glmnet, eval= TRUE, include=FALSE}

# saveRDS(mod_glmnet,"mod_glmnet.RDS")
mod_glmnet <- readRDS("mod_glmnet.RDS")
```

```{r mod_glmnet, eval=FALSE, include=TRUE}

mod_glmnet <- train(Class ~ ., 
              up_heal,
              method = "glmnet",
              tuneLength = 20,
              trControl = fitControl,
              na.action = na.omit,
              preProcess = c("nzv","corr", "pca")
              )

print(mod_glmnet)
```

```{r preprocessing}
str(mod_glmnet)
mod_glmnet$preProcess


mod_glmnet$preProcess$method$remove
```


```{r eval_glmnet_print}
print(mod_glmnet)
```
```{r eval_glmnet_matrix}
confM<- confusionMatrix(mod_glmnet)
confM
```


```{r eval_glmnet_graphs, fig.height=1.1, fig.width=1}

mod_glmnet$resample %>% 
  as.data.frame() %>% 
  gather("metric", "value", 1:3) %>% 
  group_by(metric) %>% 
  summarise(mean = mean(value), stdev = sd(value)) %>% 
  ggplot(aes(y = mean, x = metric, col = metric, fill = metric)) +
    geom_col() +
    geom_errorbar(aes(ymin = mean - stdev, ymax =  mean + stdev), width = 0.2) +
    scale_y_continuous(limits = c(0,1)) +
    scale_x_discrete(labels = c("ROC", "Sensitivity", "Specificity")) +
    geom_label(aes(y = 0.8, label = round(mean,2)), fill = "white") +
    labs(color = "",
         title = "glmnet",
         x = "",
         caption = "fig.1" ) +
    theme(legend.position = "none",
          plot.title = element_text( hjust = 0.5)
          )
```

## RPART


```{r trees, include=FALSE, eval=TRUE}
# saveRDS(mod_rpart, "mod_rpart")
# saveRDS(mod_ctree, "mod_ctree")

mod_rpart <- readRDS("mod_rpart")
mod_rtree <- readRDS("mod_rtree")

```


```{r mod_rpart, eval=FALSE, include=TRUE}

mod_rpart <- train(Class ~ ., 
              up_heal,
              method = "rpart",
              metric = "ROC",
              tuneLength = 20,
              trControl = fitControl,
              preProcess = c("nzv","corr", "pca"),
              na.action = na.omit
              # verbose = TRUE
              )
```


```{r mod_ctree, eval=FALSE, include=TRUE}
mod_ctree <- train(Class ~ ., 
                   up_heal,
                   method = "ctree",
                   metric = "ROC",
                   tuneLength = 20,
                   trControl = fitControl,
                   preProcess = c("nzv","corr", "pca"),
                   na.action = na.omit
              # verbose = TRUE
              )
```


```{r eval_trees_matrix}

confusionTable <- function (mod) {
  tidy(confusionMatrix(mod)$table) %>% 
  mutate( model = mod$method ) %>% 
  spread(model, n)
}

trees <- bind_cols(confusionTable(mod_rpart), confusionTable(mod_ctree)[,3])




kableExtra::kable( trees, "html", longtable = T, booktabs = T, caption = "Longtable")

# %>%
# add_header_above(c(" ", "Group 1" = 5, "Group 2" = 6)) %>%
# kable_styling(latex_options = c("repeat_header"))

```


## RANDOM FOREST

```{r load_rf, eval=TRUE, include=FALSE}
mod_ranger <- readRDS("mod_ranger.RDS")
```


```{r mod_rf, eval=FALSE, include=TRUE}

mod_ranger <- train(Class ~ ., 
              up_heal,
              method = "ranger",
              metric = "ROC",
              tuneLength = 5,
              trControl = fitControl,
              preProcess = c("nzv","corr", "pca"),
              na.action = na.omit
              )
```



```{r eval_rf_graph, eval=TRUE, include=TRUE}

mod_ranger$resample %>% 
  as.data.frame() %>% 
  gather("metric", "value", 1:3) %>% 
  group_by(metric) %>% 
  summarise(mean = mean(value), stdev = sd(value)) %>% 
  ggplot(aes(y = mean, x = metric, col = metric, fill = metric)) +
    geom_col() +
    geom_errorbar(aes(ymin = mean - stdev, ymax =  mean + stdev), width = 0.2) +
    scale_y_continuous(limits = c(0,1)) +
    scale_x_discrete(labels = c("ROC", "Sensitivity", "Specificity")) +
    geom_label(aes(y = 0.8, label = round(mean,2)), fill = "white") +
    labs(color = "",
         title = "randomForest",
         x = "",
         caption = "fig.2" ) +
    theme(legend.position = "none",
          plot.title = element_text( hjust = 0.5)
          )
```


```{r compare}

confusionMatrix(mod_ranger)

model_list <- list( glmnet = mod_glmnet,
                    rpart= mod_rpart)

resamps <- resamples(model_list)

# saveRDS(resamps, "resamps.RDS")
# resamps <- readRDS("resamps.RDS")

resamps$values

ggplot(resamps, metric = c("ROC", "Sens", "Spec")) +
  
 

ggplot(mod_ranger, metric = "Sens")

mean(resamps$values$`rf~Sens`)
```




# Model: 3 classes

```{r 3_resample}
get.seed(1512)
up_heal3 <- upSample(x = heal_sub_cl3[, -ncol(heal_sub_cl3)],
                     y = heal_sub_cl3$H4TO117)                         
table(up_heal$Class) 
```
```{r trainControl3}

fitControl3 <- trainControl(method = "adaptive_cv",
                           number = 5, repeats = 5,
                           summaryFunction = multiClassSummary,
                           savePredictions = "final",
                            adaptive = list(min = 2,
                                            alpha = 0.05,
                                            method = "gls",
                                            complete = TRUE),
                           verboseIter = TRUE,
                           classProbs = TRUE)

mod_ranger3 <- train(Class ~ ., 
              up_heal3,
              method = "ranger",
              metric = "ROC",
              tuneLength = 5,
              trControl = fitControl3,
              preProcess = c("nzv","corr", "pca"),
              na.action = na.omit,
              verbose = TRUE
              )

print(mod_ranger3)

confusionMatrix(mod_ranger3)
```

```{r devbug_ggplot}


getAnywhere("ggplot")

getAnywhere("ggplot.resamples")


ggplot(resamps)



ttest <- try(t.test(x$value, conf.level = cl), silent = TRUE)
# Error in t.test.default(plotData$`rf~ROC`$value, conf.level = 0.95) : 
#   data are essentially constant  
rep(NA, 3)
  

plotData <- list("Model" = "rf~ROC")

x <- list(value = list(rep(1,10)))
cl = "0.095"
t.test(rep(1,10), conf.level = 0.95)
     
plotData$`rf~ROC`$value

x <- rep(1, 10)

typeof(x)
```

