---
title: "Cassandra, Aceso and the forest"
output: html_notebook
---

In this post we will apply predicting modelling to data from [__ADD HEALTH__](https://www .cpc.unc.edu/projects/addhealth/about) a national longitudinal study that enrolled  ~90000 adolescents and followed them up for 20 years. Using the *R* package [caret](https://github.com/topepo/caret), we will train and evaluate different models for predicting  drug use behavior in adulthood from information (friends, social activities, parents) collected during adolescence.

# Introduction

The ADD HEALTH is a
The [public-use data](https://www.cpc.unc.edu/projects/addhealth/about)


[study design](https://www.cpc.unc.edu/projects/addhealth/design/designpage001.jpg/@@images/b842a2e4-e345-4384-bfc5-c724a3b55b5c.jpeg)



# Get the data and make them tidy.

We start loading some libraries.
```{r libraries, message=FALSE}
library(tidyverse)
library(purrr)
library(foreign) 
library(RSQLite)
library(caret)
library(glmnet)
library(randomForest)
library(broom)
library(rpart)
library(party)
```

The number of variables collected for the ADD HEALTH is of several thousands. We will focus our analysis on a small subset of these variables that are related to the topics of "friends, social activities and parents" and few others. Our variables have been saved in the vector ```var_select```:

```{r selected_var, eval=TRUE, include=FALSE, message=FALSE}
var_select <- scan("/Users/heverz/Documents/R_projects/muaydata/static/data-post4/variables.csv", what  = "list", sep = ",")
```

```{r show_selected, eval=TRUE, include=TRUE}
var_select
```
A description of these as well as all the other variables can be found using the [codebook web Explorer](https://www.icpsr.umich.edu/icpsrweb/content/DSDR/add-health-data-guide.html)

I download the public-use data from the [ICPSR](https://www.icpsr.umich.edu/icpsrweb/DSDR/studies/21600#) and saved all the files with dta (Stata) extension in a folder.

We import all the files, select the columns that are in var_select and we join the dataframes together by the subject identification variable (```AID```) that then we remove. Finaly, all the the columns that contain character data are transformed to factors.
```{r getdata, eval=FALSE}
files <- list.files(path = "/Users/heverz/Documents/R_projects/DATASETS/W1-4",
                    include.dirs=FALSE,
                    full.names = TRUE)

#import all the dataframes.
w1_4 <- map(files, read.dta)

# Select the varibles in var_select
w1_4_reduced <- map(w1_4, function (x) x[, colnames(x) %in% var_select])

#join not empty dataframes
toselect <- which(map(w1_4_reduced, function(x) ncol(x) > 0) == TRUE)


heal_data <- plyr::join_all(w1_4_reduced[toselect] , by = "AID", type = "inner")

heal_sub <- heal_data[,2:length(heal_data)] # remove AID column
heal_sub <- mutate_if(heal_sub, is.character, as.factor)
glimpse(heal_sub)
```

```{r database, include=FALSE, eval=TRUE}
mydb <- dbConnect(RSQLite::SQLite(), "/Users/heverz/Documents/R_projects/muaydata/static/data-post4/heal_data.sqlite")

# dbWriteTable(mydb, "heal_data", heal_data)
# dbRemoveTable(mydb, "heal_data")
# dbListTables(mydb)
heal_data <- as_tibble(tbl(mydb, "heal_data"))
```

The *H4TO117* is our classifier, the response to the following question:

*"Have you ever continued to use {favorite drug} after you realized using {favorite drug} was causing you any emotional problems (such as feeling depressed or empty, feeling irritable or aggressive, feeling paranoid or confused, feeling anxious or tense, being jumpy or easily startled) or causing you any health problems (such as heart pounding, headaches or dizziness, or sexual difficulties)?"*
Let's clean up and see the responses.

```{r select_classifier}
#classifier
heal_sub_cl <- 
  heal_sub %>%
  select(-c("GSWGT4_2")) %>% 
  mutate(H4TO117 = as.factor(str_extract(H4TO117 , "[:alpha:]+")))

summary(heal_sub_cl$H4TO117)
```
Legitimate standes for Legitimate skips, that indicates those people that do not have a favorite drug.

The answers to this question not only allow to distinguish people that use (or had used drugs) from people that did not (legitimate skip), but also to identify those individuals that continue to assume drugs despite negative consequences (yes). The class "yes" will be our class of interest becouse it indicates those people that are presumably more likely to develop health problems as a consequene of drug use patterns. 


```{r 2Classes}
heal_sub_cl$H4TO117[heal_sub_cl$H4TO117 == "Legitimate"] <- "No"

heal_sub_cl$H4TO117 <- droplevels(heal_sub_cl$H4TO117)

summary(heal_sub_cl$H4TO117)
```

..and here we have the first problem: a  data is missing.


In particular a big chunck of data of columns named "PA" followed by a number is missing. 

```{r count_NAs}
heal_sub[is.na(heal_sub$PA10),] %>% 
  select(PA34:PC49E_3) %>% 
  glimpse()
```
These are variables of Parent Questionaire and part of the parents (12%) did not send it back.


https://www.cpc.unc.edu/projects/addhealth/faqs/aboutdata/index.html#how-do-i-correct-1
https://www.cpc.unc.edu/projects/addhealth/documentation/guides/wt_guidelines_20161213.pdf
Another scenario is when the outcome variable is from one wave of data, i.e., Wave I, II, III or IV,
but the predictors (or covariates) are from either previous wave(s) or a combination of waves.
Under these circumstances, the correct weight would be the cross-sectional weight for the wave
from where the outcome variable comes, rather than the longitudinal weight (see Table 2.4). If you
are using data from multiple waves for covariates (predictor variables), you might also need to use
the subpopulation option (see example 3 in Chapter 4).

df.expanded <- df[rep(row.names(df), df$freq), 1:2]

# 2 Classes

Classifier of interest is H4T0117


W4	H4TO117	Have you ever continued to use {favorite drug} after you realized using {favorite drug} was causing you any emotional problems (such as feeling depressed or empty, feeling irritable or aggressive, feeling paranoid or confused, feeling anxious or tense, being jumpy or easily startled) or causing you any health problems (such as heart pounding, headaches or dizziness, or sexual difficulties)?


  



The problem is that we have a very unballanced designed and therefore all the models tend to maximaze accuracy but not specificity (they say all not addicted). So we need to consider specificity as a metric too



# Models: 2 classes

## Resample
```{r resample}

set.seed(1512)
up_heal <- upSample(x = heal_sub_cl[, -ncol(heal_sub_cl)],
                     y = heal_sub_cl$H4TO117)                         
table(up_heal$Class) 

```


## TrainControl

Explain adaptative cross validation and the other info
```{r trainControl}
seeds = 1502
fitControl <- trainControl(method = "adaptive_cv",
                           number = 5, repeats = 5,
                           classProbs = TRUE,
                           summaryFunction = twoClassSummary,
                           savePredictions = "final",
                            adaptive = list(min = 2,
                                            alpha = 0.05,
                                            method = "gls",
                                            complete = TRUE),
                           sampling = "up",
                           verboseIter = TRUE)
                           

```

## GLMNET MODEL


```{r load_glmnet, eval= TRUE, include=FALSE}

# saveRDS(mod_glmnet,"mod_glmnet.RDS")
mod_glmnet <- readRDS("mod_glmnet.RDS")
```

```{r mod_glmnet, eval=FALSE, include=TRUE}

mod_glmnet <- train(H4TO117 ~ ., 
              heal_sub_cl,
              method = "glmnet",
              tuneLength = 20,
              trControl = fitControl,
              na.action = na.omit,
              preProcess = c("nzv","corr", "knnImpute","pca")
              na.actin=na.pass
              )

print(mod_glmnet)
```

```{r preprocessing}
str(mod_glmnet)
mod_glmnet$preProcess


mod_glmnet$preProcess$method$remove
```


```{r eval_glmnet_print}
print(mod_glmnet)
```
```{r eval_glmnet_matrix}
confusionTable <- function (mod) {
  tidy(confusionMatrix(mod)$table) %>% 
  mutate( model = mod$method) %>% 
  spread(model, n) %>% 
  mutate(Case = c("True Negative", 
                   "False Negative",
                   "False Postive", 
                   "True Positive")) %>% 
  arrange(Case) %>% 
  select(Case, everything()) %>% 
  mutate_if(is.numeric, round, 2)
}

table_glmnet <- confusionTable(mod_glmnet)

table_glmnet
```
```{r}
table_glmnet <- confusionTable(mod_glmnet_w)
```


## TREES


```{r load_trees, include=FALSE, eval=TRUE}
# saveRDS(mod_rpart, "mod_rpart")
# saveRDS(mod_ctree, "mod_ctree")

mod_rpart <- readRDS("mod_rpart")
mod_ctree <- readRDS("mod_ctree")

```


```{r mod_rpart, eval=FALSE, include=TRUE}

mod_rpart <- train(Class ~ ., 
              up_heal,
              method = "rpart",
              metric = "ROC",
              tuneLength = 20,
              trControl = fitControl,
              preProcess = c("nzv","corr", "pca"),
              na.action = na.omit
              # verbose = TRUE
              )
```

https://cran.r-project.org/web/packages/partykit/vignettes/ctree.pdf
```{r mod_ctree, eval=FALSE, include=TRUE}
mod_ctree <- train(Class ~ ., 
                   up_heal,
                   method = "ctree",
                   metric = "ROC",
                   tuneLength = 20,
                   trControl = fitControl,
                   preProcess = c("nzv","corr", "pca"),
                   na.action = na.omit
              # verbose = TRUE
              )
```


```{r eval_trees_matrix}


table_m3 <- bind_cols(table_glmnet,
            confusionTable(mod_rpart)[,4], 
            confusionTable(mod_ctree)[,4])


table_m3

```


## RANDOM FOREST

```{r load_rf, eval=TRUE, include=FALSE}
mod_ranger <- readRDS("mod_ranger.RDS")
```


```{r mod_rf, eval=FALSE, include=TRUE}

mod_ranger <- train(Class ~ ., 
              up_heal,
              method = "ranger",
              metric = "ROC",
              tuneLength = 5,
              trControl = fitControl,
              preProcess = c("nzv","corr", "pca"),
              na.action = na.omit
              )
```

```{r eval_matrix, eval=TRUE, include=FALSE}
table_m4  <- bind_cols(table_m3,
            confusionTable(mod_ranger)[,4])
table_m4 
```




## Compareall
```{r eval_all_graph, eval=TRUE, include=TRUE, warning=FALSE}


model_list <- list( glmnet = mod_glmnet,
                    rpart = mod_rpart,
                    ctree = mod_ctree,
                    ranger = mod_ranger)


resamps <- resamples(model_list)

# getAnywhere("ggplot.resamples")


resamps$values %>% 
  gather("model~metric", "value", 2:13) %>% 
  separate ("model~metric", c("model", "metric")) %>% 
  mutate(model = factor(model, levels = names(table_m4[4:7]))) %>% 
  group_by(model, metric) %>% 
  summarize(mean = mean(value), sd = sd(value)) %>% 
  
  ggplot(aes(y= mean, x = model, col = model)) +
    geom_point(size = 2.5) +
    geom_errorbar(aes(ymin = mean - sd, ymax =  mean + sd), width = 0.1) +
    scale_y_continuous(limits = c(0.5, 1)) + 
    coord_flip() +
    facet_wrap(metric ~ .) +
    theme(legend.position = "none")
```




# Model: 3 classes

```{r 3_resample}
get.seed(1512)
up_heal3 <- upSample(x = heal_sub_cl3[, -ncol(heal_sub_cl3)],
                     y = heal_sub_cl3$H4TO117)                         
table(up_heal$Class) 
```
```{r trainControl3}

fitControl3 <- trainControl(method = "adaptive_cv",
                           number = 5, repeats = 5,
                           summaryFunction = multiClassSummary,
                           savePredictions = "final",
                            adaptive = list(min = 2,
                                            alpha = 0.05,
                                            method = "gls",
                                            complete = TRUE),
                           verboseIter = TRUE,
                           classProbs = TRUE)

mod_ranger3 <- train(Class ~ ., 
              up_heal3,
              method = "ranger",
              metric = "ROC",
              tuneLength = 5,
              trControl = fitControl3,
              preProcess = c("nzv","corr", "pca"),
              na.action = na.omit,
              verbose = TRUE
              )

print(mod_ranger3)

confusionMatrix(mod_ranger3)
```

    
    


